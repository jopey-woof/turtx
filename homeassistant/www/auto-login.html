<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üê¢ Turtle Monitor - Auto Login</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #0A0F07 0%, #1A2F0B 50%, #2D5016 100%);
            color: #FFFFFF;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .container {
            text-align: center;
            background: rgba(26, 47, 11, 0.8);
            padding: 40px;
            border-radius: 12px;
            border: 2px solid #4A7C59;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .turtle-icon {
            font-size: 4em;
            margin-bottom: 20px;
            animation: turtle-pulse 2s ease-in-out infinite;
        }
        @keyframes turtle-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 140, 66, 0.2);
            border: 1px solid #FF8C42;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #FF8C42;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .error {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #FF6B6B;
        }
        .success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="turtle-icon">üê¢</div>
        <h1>Turtle Monitor</h1>
        <div id="status" class="status">
            <div class="loading"></div>
            <span id="status-text">Initializing...</span>
        </div>
    </div>

    <script>
        // Kiosk user credentials
        const kioskUser = {
            username: 'turtle_kiosk',
            password: 'turtle_kiosk_secure_2024!'
        };

        // Home Assistant base URL
        const baseUrl = window.location.origin;
        
        // Dashboard URL - try different possible paths
        const dashboardUrls = [
            '/lovelace',
            '/lovelace-kiosk',
            '/lovelace/default_view',
            '/lovelace/home'
        ];

        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            const statusText = document.getElementById('status-text');
            
            statusText.textContent = message;
            statusElement.className = `status ${type}`;
        }

        async function tryDashboardAccess() {
            updateStatus('Trying to access dashboard...', 'info');
            
            for (const dashboardUrl of dashboardUrls) {
                try {
                    const response = await fetch(`${baseUrl}${dashboardUrl}`, {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        updateStatus(`Dashboard found at ${dashboardUrl}`, 'success');
                        return `${baseUrl}${dashboardUrl}`;
                    }
                } catch (error) {
                    console.log(`Failed to access ${dashboardUrl}:`, error);
                }
            }
            
            // If no dashboard found, try the main page
            updateStatus('Using main dashboard', 'info');
            return `${baseUrl}/lovelace`;
        }

        async function autoLogin() {
            try {
                updateStatus('Attempting auto-login...', 'info');
                
                // Perform login
                const loginResponse = await fetch(`${baseUrl}/auth/login_flow`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        client_id: 'https://home-assistant.io/android/',
                        handler: ['homeassistant', null],
                        redirect_uri: 'homeassistant://auth-callback'
                    })
                });

                if (!loginResponse.ok) {
                    throw new Error('Login flow failed');
                }

                const loginData = await loginResponse.json();
                
                // Submit credentials
                const submitResponse = await fetch(`${baseUrl}/auth/login_flow/${loginData.flow_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: kioskUser.username,
                        password: kioskUser.password
                    })
                });

                if (!submitResponse.ok) {
                    throw new Error('Login failed');
                }

                const submitData = await submitResponse.json();
                
                if (submitData.result === 4) { // Success
                    updateStatus('Login successful! Finding dashboard...', 'success');
                    
                    // Store the access token
                    if (submitData.access_token) {
                        localStorage.setItem('hassTokens', JSON.stringify({
                            access_token: submitData.access_token,
                            expires_in: submitData.expires_in,
                            refresh_token: submitData.refresh_token
                        }));
                    }
                    
                    // Try to find the correct dashboard URL
                    const dashboardUrl = await tryDashboardAccess();
                    
                    // Redirect to dashboard after a short delay
                    setTimeout(() => {
                        updateStatus('Redirecting to dashboard...', 'success');
                        window.location.href = dashboardUrl;
                    }, 1000);
                    
                } else {
                    throw new Error('Login unsuccessful');
                }

            } catch (error) {
                console.error('Auto-login error:', error);
                updateStatus(`Login failed: ${error.message}`, 'error');
                
                // Fallback: try direct dashboard access
                setTimeout(async () => {
                    updateStatus('Trying direct dashboard access...', 'info');
                    const dashboardUrl = await tryDashboardAccess();
                    window.location.href = dashboardUrl;
                }, 3000);
            }
        }

        async function init() {
            updateStatus('Starting auto-login process...', 'info');
            
            // Wait a moment for Home Assistant to fully initialize
            setTimeout(() => {
                autoLogin();
            }, 2000);
        }

        // Start the auto-login process when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
